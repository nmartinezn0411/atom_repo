<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test Frontend</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .response-section { display: none; }
        .tool-call { background-color: #f8f9fa; }
        .sql-query { font-family: monospace; white-space: pre-wrap; }
        .api-key-field { position: relative; }
        .toggle-password { 
            position: absolute; 
            right: 10px; 
            top: 50%; 
            transform: translateY(-50%); 
            background: none; 
            border: none; 
            cursor: pointer; 
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Header -->
                <div class="text-center mb-4">
                    <h1 class="display-5 fw-bold text-primary">API Test Frontend</h1>
                    <p class="lead">Probando Proyecto de Prueba de ATOM</p>
                </div>

                <!-- Input Section -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <!-- API Key Field -->
                        <div class="mb-3">
                            <label for="apiKey" class="form-label fw-semibold">API Key:</label>
                            <div class="api-key-field">
                                <input type="password" class="form-control" id="apiKey" 
                                       placeholder="Ingresa tu API key aqu√≠"
                                       value="example">
                                <button type="button" class="toggle-password" onclick="togglePasswordVisibility()">
                                    üëÅÔ∏è
                                </button>
                            </div>
                            <div class="form-text">Esta clave se enviar√° con tu pregunta al servidor.</div>
                        </div>

                        <!-- Question Field -->
                        <div class="mb-3">
                            <label for="question" class="form-label fw-semibold">Escriba la pregunta:</label>
                            <textarea class="form-control" id="question" rows="3" 
                                      placeholder="¬øCu√°l fue el precio promedio de venta en Chile?"></textarea>
                        </div>
                        
                        <button class="btn btn-primary btn-lg" onclick="sendQuestion()" id="submitBtn">
                            Enviar pregunta
                        </button>
                        
                        <!-- Loading Spinner -->
                        <div class="mt-3 text-center" id="loading" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2 text-muted">Procesando la pregunta...</p>
                        </div>
                    </div>
                </div>

                <!-- Response Section -->
                <div class="card shadow-sm response-section" id="responseSection">
                    <div class="card-body">
                        <!-- Final Answer -->
                        <div class="mb-4" id="finalAnswerBlock" style="display:none;">
                            <h5 class="text-success mb-3">Respuesta Final</h5>
                            <div class="alert alert-success" id="finalAnswer"></div>
                        </div>

                        <!-- Tool Calls -->
                        <div class="mb-4" id="toolCallsSection" style="display: none;">
                            <h5 class="text-info mb-3">Tool Calls</h5>
                            <div id="toolCalls"></div>
                        </div>

                        <!-- Query Results -->
                        <div class="mb-4" id="resultsSection" style="display: none;">
                            <h5 class="text-warning mb-3">Query Results</h5>
                            <div class="mb-3">
                                <strong>SQL Ejecutado:</strong>
                                <div class="sql-query bg-dark text-light p-3 rounded mt-1" id="executedSql"></div>
                            </div>
                            <div id="resultsTable"></div>
                        </div>
                    </div>
                </div>

                <!-- Error Section -->
                <div class="alert alert-danger response-section" id="errorSection" role="alert">
                    <h5>Error</h5>
                    <p id="errorText"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const el = (id) => document.getElementById(id);
        const show = (id) => el(id).style.display = 'block';
        const hide = (id) => el(id).style.display = 'none';

        // Toggle password visibility
        function togglePasswordVisibility() {
            const apiKeyField = el('apiKey');
            const toggleButton = document.querySelector('.toggle-password');
            
            if (apiKeyField.type === 'password') {
                apiKeyField.type = 'text';
                toggleButton.textContent = 'üîí';
            } else {
                apiKeyField.type = 'password';
                toggleButton.textContent = 'üëÅÔ∏è';
            }
        }

        function resetUI() {
            // Hide all sections
            document.querySelectorAll('.response-section').forEach(s => s.style.display = 'none');
            hide('toolCallsSection');
            hide('resultsSection');
            hide('finalAnswerBlock');

            // Clear contents
            el('finalAnswer').textContent = '';
            el('toolCalls').innerHTML = '';
            el('executedSql').textContent = '';
            el('resultsTable').innerHTML = '';
            el('errorText').textContent = '';
        }

        async function sendQuestion() {
            const question = el('question').value.trim();
            const apiKey = el('apiKey').value.trim();
            const submitBtn = el('submitBtn');
            const loading = el('loading');

            if (!question) {
                alert('Por favor ingresa una pregunta');
                return;
            }

            if (!apiKey) {
                alert('Por favor ingresa tu API Key');
                return;
            }

            // Full reset before every new request (ensures complete re-render)
            resetUI();
            loading.style.display = 'block';
            submitBtn.disabled = true;

            try {
                //const response = await fetch('http://127.0.0.1:8000/ask', {
                const response = await fetch('https://atomrepo-production.up.railway.app/ask', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({ question })
                });

                // Try to parse JSON even for non-200 to extract errors
                let data;
                try {
                    data = await response.json();
                } catch {
                    data = null;
                }

                if (!response.ok) {
                    const msg = data?.detail || `HTTP error! status: ${response.status}`;
                    throw new Error(msg);
                }

                // Render (or not) based on content
                displayResponse(data);

            } catch (error) {
                showError(error.message);
            } finally {
                loading.style.display = 'none';
                submitBtn.disabled = false;
            }
        }
        
        function displayResponse(data) {
            const finalAnswer = (data?.final_answer ?? '').trim();

            // If the new answer is empty, show nothing at all (keep everything hidden)
            if (!finalAnswer) {
                return;
            }

            // Final Answer
            el('finalAnswer').textContent = finalAnswer;
            show('finalAnswerBlock');

            // Tool Calls
            const toolCalls = Array.isArray(data?.tool_calls) ? data.tool_calls : [];
            if (toolCalls.length > 0) {
                el('toolCalls').innerHTML = toolCalls.map((tool, index) => `
                    <div class="tool-call p-3 mb-2 rounded">
                        <strong>Tool ${index + 1}:</strong> ${tool.tool_name ?? ''}<br>
                        <strong>Query:</strong> ${(tool.arguments && (tool.arguments.query ?? ''))}
                    </div>
                `).join('');
                show('toolCallsSection');
            }

            // Query Results
            const result = data?.result;
            if (result) {
                // Executed SQL (may be empty)
                el('executedSql').textContent = result.executed_sql ?? '';

                const columns = Array.isArray(result.columns) ? result.columns : [];
                const rows = Array.isArray(result.rows) ? result.rows : [];

                if (columns.length > 0 && rows.length > 0) {
                    el('resultsTable').innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-dark">
                                    <tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>
                                </thead>
                                <tbody>
                                    ${rows.map(row => `
                                        <tr>${columns.map(col => `<td>${row[col]}</td>`).join('')}</tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    el('resultsTable').innerHTML = '';
                }

                show('resultsSection');
            }

            // Only show the response container if something is visible inside
            if (el('finalAnswerBlock').style.display === 'block' ||
                el('toolCallsSection').style.display === 'block' ||
                el('resultsSection').style.display === 'block') {
                show('responseSection');
            }
        }
        
        function showError(message) {
            resetUI(); // ensure nothing else is showing
            el('errorText').textContent = message || 'Unknown error';
            show('errorSection');
        }

        // Enter key support (Ctrl+Enter to send)
        el('question').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                sendQuestion();
            }
        });

        // Allow Enter key in API field to move to question field
        el('apiKey').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                el('question').focus();
            }
        });
    </script>
</body>
</html>